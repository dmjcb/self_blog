---
title: "c ABI"
date: 2026-02-02
categories: [c_c++]
tags: [c_c++]
excerpt: "C"
---

# c ABI

## ABIå®šä¹‰

## åœºæ™¯

ğŸš¨ ä»¥ä¸‹æ“ä½œ = ABI ç ´å

âŒ æ”¹å‡½æ•°å‚æ•°é¡ºåº
âŒ æ”¹å‚æ•°ç±»å‹(int â†’ long)
âŒ æ”¹è¿”å›ç±»å‹
âŒ åˆ é™¤å¯¼å‡ºå‡½æ•°
âŒ æ”¹ struct å¸ƒå±€
âŒ æ”¹ enum å€¼å«ä¹‰

âœ… ä»¥ä¸‹æ“ä½œ = ABI å®‰å…¨

âœ” æ–°å¢å‡½æ•°
âœ” æ–°å¢ enum å€¼(ä¸æ”¹æ—§å€¼)
âœ” æ–°å¢ struct å­—æ®µ(åœ¨æœ«å°¾ + size å­—æ®µ)
âœ” ä¿®å¤å®ç° bug

## å®‰å…¨ç­–ç•¥

### opaque handle

```c
// foo_c_api.h
#ifdef __cplusplus
extern "C" {
#endif

typedef struct FooHandle FooHandle;

FooHandle* foo_create(int x);

void foo_destroy(FooHandle* h);

int foo_add(FooHandle* h, int v);

#ifdef __cplusplus
}
#endif
```

```c++
// foo.cpp
#include"foo_c_api.h"
#include <iostream>

class Foo {
public:
    explicit Foo(int x) : x_(x) {}

    int add(int v) {
        return x_ + v;
    }
private:
    int x_;
};

struct FooHandle {
    Foo* impl;
};

extern "C" {

FooHandle* foo_create(int x) {
    return new FooHandle{ new Foo(x) };
}

void foo_destroy(FooHandle* h) {
    delete h->impl;
    delete h;
}

int foo_add(FooHandle* h, int v) {
    return h->impl->add(v);
}

}
```

### struct Versioning (ç»“æ„ä½“ç‰ˆæœ¬åŒ–)

å¤©çœŸå†™æ³•(ä¸å¯æ‰©å±•)

```c
typedef struct {
    int a;
    int b;
} FooConfig;
```

âœ… å·¥ä¸šçº§å†™æ³•
```c++
typedef struct {
    uint32_t size;      // å¿…é¡»
    uint32_t version;   // å¯é€‰
    int a;
    int b;
} FooConfig;
```

ä½¿ç”¨æ–¹å¼

```c++
FooConfig cfg = {
    .size = sizeof(FooConfig),
    .version = 1,
    .a = 1,
    .b = 2
};
```

c++ å†…éƒ¨åˆ¤æ–­
```c
if (cfg.size >= offsetof(FooConfig, b) + sizeof(int)) {
    // å¯ä»¥å®‰å…¨è®¿é—® b
}

```

â“ ä¸ºä»€ä¹ˆä¸ç”¨ C++ class ç›´æ¥å¯¼å‡ºï¼Ÿ
ğŸ‘‰ ABI ä¸ç¨³å®š

â“ extern "C" è§£å†³äº†ä»€ä¹ˆï¼Ÿ
ğŸ‘‰ åå­—æ”¹ç¼–, ä¸è§£å†³ ABI å¤æ‚æ€§

â“ ä¸ºä»€ä¹ˆç”¨ä¸é€æ˜æŒ‡é’ˆï¼Ÿ
ğŸ‘‰ éšè—å®ç° + ABI ç¨³å®š

â“ C èƒ½ä¸èƒ½ new/deleteï¼Ÿ
ğŸ‘‰ âŒ å¿…é¡»å°è£…

â“ å¼‚å¸¸æ€ä¹ˆå¤„ç†ï¼Ÿ
ğŸ‘‰ C ABI è¾¹ç•Œå…¨éƒ¨ catch

â“ STL èƒ½ä¸èƒ½å‡ºç°åœ¨å¤´æ–‡ä»¶ï¼Ÿ
ğŸ‘‰ âŒ åªèƒ½åœ¨ cpp å†…éƒ¨
